WITH JOIN_M AS ( SELECT *
                FROM USER_INFO
                WHERE YEAR(JOINED)='2021'
               )
,SALE_M AS (    SELECT *
                 FROM ONLINE_SALE
                 WHERE USER_ID IN (SELECT USER_ID FROM JOIN_M)
            )
SELECT YEAR(A.SALES_DATE) AS YEAR
        ,MONTH(A.SALES_DATE) AS MONTH
        ,COUNT(DISTINCT A.USER_ID) AS PUCHASED_USERS
        ,ROUND(COUNT(DISTINCT A.USER_ID)/(SELECT COUNT(USER_ID) FROM JOIN_M),1) AS PUCHASED_RATIO
FROM SALE_M A
GROUP BY  YEAR(A.SALES_DATE),MONTH(A.SALES_DATE)
ORDER BY 1,2;
